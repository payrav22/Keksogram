(()=>{"use strict";const e=e=>"Esc"===e.key||"Escape"===e.key,t=document.querySelector(".big-picture"),r=document.querySelector("body"),c=document.querySelector(".big-picture__cancel"),n=document.querySelector("#comment").content.querySelector(".social__comment"),s=document.querySelector(".social__comments");let o=[];const l=t.querySelector(".social__comment-count"),i=t.querySelector(".comments-loader");let a=5;const d=()=>{t.classList.add("hidden"),r.classList.remove("modal-open"),c.removeEventListener("click",d),s.innerHTML="",document.removeEventListener("keydown",m),a=5,o=[]},u=e=>{o=e.slice(0,a),s.innerHTML="",l.textContent=`${o.length} из ${e.length} комментариев`;let t=document.createDocumentFragment();o.forEach((e=>{t.appendChild((e=>{const t=n.cloneNode(!0);return t.querySelector(".social__picture").src=e.avatar,t.querySelector(".social__picture").alt=e.name,t.querySelector(".social__text").textContent=e.message,t})(e))})),s.appendChild(t),e.length>5&&o.length<e.length?(i.classList.remove("hidden"),i.addEventListener("click",(()=>{u(e)}),{once:!0})):i.classList.add("hidden"),a+=5},m=t=>{e(t)&&d()},y=document.querySelector("#picture").content.querySelector(".picture"),v=document.querySelector(".pictures"),_=e=>{let n=document.createDocumentFragment();e.forEach((e=>{n.appendChild((e=>{const n=y.cloneNode(!0);return n.querySelector(".picture__img").src=e.url,n.querySelector(".picture__likes").textContent=e.likes,n.querySelector(".picture__comments").textContent=e.comments.length,n.addEventListener("click",(n=>{n.preventDefault(),(e=>{a=5,o=[],r.classList.add("modal-open"),t.querySelector(".big-picture__img > img").src=e.url,t.querySelector(".likes-count").textContent=e.likes,t.querySelector(".social__caption").textContent=e.description,c.addEventListener("click",d),t.classList.remove("hidden"),document.addEventListener("keydown",m),u(e.comments.slice())})(e)})),n})(e))})),v.appendChild(n)},p={GET:"https://22.javascript.pages.academy/kekstagram/data",POST:"https://22.javascript.pages.academy/kekstagram"},g=(e,t,r,c)=>{fetch(p[r],{method:r,body:c}).then((e=>e.json())).then((t=>{e(t)})).catch((()=>{t()}))},L=document.querySelector("main"),S=document.querySelector("#error").content,h=document.createDocumentFragment(),q=document.querySelector("#success").content,f=document.createDocumentFragment(),k=t=>{e(t)&&E()},E=e=>{document.querySelector(e).remove(),document.removeEventListener("keydown",k)},C=(e,t)=>{const r=S.cloneNode(!0);r.querySelector(".error__title").textContent=e,r.querySelector(".error__button").textContent=t;const c=r.querySelector(".error__button");r.querySelector(".error").addEventListener("click",(e=>{e.target.classList.contains("error__inner")||E(".error")})),c.addEventListener("click",(()=>{E(".error")})),document.addEventListener("keydown",k),h.appendChild(r),L.appendChild(h)},w=document.querySelector(".img-upload__effects"),b=document.querySelector(".img-upload__effect-level"),x=document.querySelector(".effect-level__slider"),D=document.querySelector(".img-upload__preview > img"),T=document.querySelector(".effect-level__value");b.classList.add("visually-hidden");let V="";const $={none:()=>(b.classList.add("visually-hidden"),"none"),chrome:()=>(b.classList.remove("visually-hidden"),`grayscale(${.01*parseInt(T.value,10)})`),sepia:()=>(b.classList.remove("visually-hidden"),`sepia(${.01*parseInt(T.value,10)})`),marvin:()=>(b.classList.remove("visually-hidden"),`invert(${Math.floor(T.value)}%)`),phobos:()=>(b.classList.remove("visually-hidden"),`blur(${3*parseInt(T.value,10)*.01}px)`),heat:()=>(b.classList.remove("visually-hidden"),`brightness(${3*parseInt(T.value,10)*.01})`)};w.addEventListener("click",(e=>{if(e.target.classList.contains("effects__preview")){""!==V&&D.classList.remove(V),x.noUiSlider.set(100);let t=e.target.classList[1];V=t,D.classList.add(t),D.style.filter=$[t.replace("effects__preview--","")]()}})),window.noUiSlider.create(x,{range:{min:0,max:100},start:100,connect:"lower"}),x.noUiSlider.on("change",(()=>{T.value=x.noUiSlider.get(),D.style.filter=$[V.replace("effects__preview--","")]()}));const I=document.querySelector("body"),F=document.querySelector(".img-upload__overlay"),M=document.querySelector("#upload-file"),N=document.querySelector("#upload-cancel");M.addEventListener("change",(()=>{H(),F.classList.remove("hidden"),I.classList.add("modal-open")}));const O=()=>{F.classList.add("hidden"),I.classList.remove("modal-open"),M.value=""};N.addEventListener("click",(()=>{O()})),document.addEventListener("keydown",(t=>{e(t)&&O()}));const U=F.querySelector(".scale__control--bigger"),j=F.querySelector(".scale__control--smaller"),P=F.querySelector(".scale__control--value"),G=F.querySelector(".img-upload__preview > img"),H=()=>{G.style="transform: scale(1.00)",G.style.filter="",V&&G.classList.remove(V),P.value="100%",b.classList.add("visually-hidden")};U.addEventListener("click",(()=>{let e=parseInt(P.value,10)+25;e>=100&&(e=100),P.value=e+"%",e/=100,G.style.transform="scale("+e+")"})),j.addEventListener("click",(()=>{let e=parseInt(P.value,10)-25;e<=25&&(e=25),P.value=e+"%",e/=100,G.style.transform="scale("+e+")"}));const A=document.querySelector(".img-upload__form"),z=()=>{(e=>{const t=q.cloneNode(!0);t.querySelector(".success__title").textContent="Ура!";const r=t.querySelector(".success__button");t.querySelector(".success").addEventListener("click",(e=>{e.target.classList.contains("success__inner")||E(".success")})),r.addEventListener("click",(()=>{E(".success")})),document.addEventListener("keydown",k),f.appendChild(t),L.appendChild(f)})(),O(),A.reset()},B=()=>{C("ЧТо-то пошло не так","Загрузить другой файл")};A.addEventListener("submit",(e=>{e.preventDefault(),g(z,B,"POST",new FormData(e.target))}));let J=document.querySelector(".text__hashtags"),K=document.querySelector(".text__description");J.addEventListener("input",(()=>{J.setCustomValidity("");let e=J.value.toLowerCase().trim();if(!e)return;let t=e.split(/\s+/);0!==!t.length&&(t.some((e=>"#"!==e[0]))&&J.setCustomValidity("Хэш-тег начинается с символа # (решётка)"),t.some((e=>"#"===e))&&J.setCustomValidity("Хэш-тег не может состоять только из решетки"),t.some((e=>e.indexOf("#",1)>=1))&&J.setCustomValidity("Хэш-теги разделяются пробелами"),t.some(((e,t,r)=>r.indexOf(e,t+1)>=t+1))&&J.setCustomValidity("Хэш-теги не должны повторяться"),t.some((e=>e.length>20))&&J.setCustomValidity("Максимальная длина хэш-тега 20 символов, включая решетку"),t.length>5&&J.setCustomValidity("Максимум 5 хэш-тегов"))}));const Q=t=>{e(t)&&(t.preventDefault(),t.stopPropagation())};J.addEventListener("keydown",Q),K.addEventListener("keydown",Q);const R=document.querySelector(".img-filters");let W=[];const X={"filter-default":()=>{_(W.slice(0,25))},"filter-random":()=>{_((e=>{let t,r;for(let c=e.length-1;c>0;c--)t=Math.floor(Math.random()*(c+1)),r=e[t],e[t]=e[c],e[c]=r;return e})(W.slice()).slice(0,10))},"filter-discussed":()=>{_(W.slice().sort(((e,t)=>t.comments.length-e.comments.length)))}};g((e=>{R.classList.remove("img-filters--inactive"),W=e.slice(),_(W.slice(0,25))}),(()=>{C("Ошибка загрузки, попробуйте еще раз","Закрыть")}),"GET");const Y=(e=>{let t=null;return(...e)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{(e=>{e.target.classList.contains("img-filters__button")&&(document.querySelector(".img-filters__button--active").classList.remove("img-filters__button--active"),(()=>{const e=document.querySelectorAll(".picture");e&&e.forEach((e=>{e.remove()}))})(),e.target.classList.add("img-filters__button--active"),X[e.target.id]())})(...e)}),500)}})();R.addEventListener("click",Y)})();